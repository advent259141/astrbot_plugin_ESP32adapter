# ESP32S3 WebSocketæ§åˆ¶å™¨æ’ä»¶

è¿™æ˜¯ä¸€ä¸ªä¸ºAstrBotå¼€å‘çš„æ’ä»¶ï¼Œç”¨äºä¸ESP32S3è®¾å¤‡å»ºç«‹WebSocketè¿æ¥ï¼Œå®ç°åŒå‘é€šä¿¡å’Œæ¶ˆæ¯è½¬å‘åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ”— **WebSocketæœåŠ¡å™¨**: åœ¨AstrBotä¸­å¯åŠ¨WebSocketæœåŠ¡å™¨ï¼Œç›‘å¬ESP32è®¾å¤‡è¿æ¥
- ğŸ“± **æ¶ˆæ¯è½¬å‘**: å°†å¹³å°æ”¶åˆ°çš„æ‰€æœ‰æ¶ˆæ¯å®æ—¶è½¬å‘ç»™è¿æ¥çš„ESP32è®¾å¤‡
- ğŸ® **è®¾å¤‡æ§åˆ¶**: é€šè¿‡æŒ‡ä»¤å‘ESP32è®¾å¤‡å‘é€æ§åˆ¶å‘½ä»¤
- ğŸ“Š **çŠ¶æ€ç›‘æ§**: å®æ—¶ç›‘æ§ESP32è®¾å¤‡è¿æ¥çŠ¶æ€å’Œä¼ æ„Ÿå™¨æ•°æ®
- ğŸ’“ **å¿ƒè·³æœºåˆ¶**: ä¿æŒè¿æ¥ç¨³å®šæ€§ï¼Œè‡ªåŠ¨å¤„ç†æ–­çº¿é‡è¿

## å®‰è£…æ­¥éª¤

1. å°†æœ¬æ’ä»¶æ–‡ä»¶å¤¹å¤åˆ¶åˆ°AstrBotçš„ `data/plugins/` ç›®å½•ä¸‹
2. é‡å¯AstrBotæˆ–åœ¨ç®¡ç†é¢æ¿ä¸­é‡è½½æ’ä»¶
3. æ’ä»¶ä¼šè‡ªåŠ¨å¯åŠ¨WebSocketæœåŠ¡å™¨ï¼ˆé»˜è®¤ç«¯å£8765ï¼‰

## ä½¿ç”¨æ–¹æ³•

### AstrBotç«¯æŒ‡ä»¤

| æŒ‡ä»¤ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `/esp32` | æŸ¥çœ‹ESP32è®¾å¤‡è¿æ¥çŠ¶æ€ | `/esp32` |
| `/esp32_status` | è¯¦ç»†çš„è¿æ¥çŠ¶æ€ä¿¡æ¯ | `/esp32_status` |
| `/esp32_send <æ¶ˆæ¯>` | å‘ESP32è®¾å¤‡å‘é€è‡ªå®šä¹‰æ¶ˆæ¯ | `/esp32_send led_on` |

### ESP32ç«¯å¼€å‘

#### ç¡¬ä»¶è¦æ±‚
- ESP32S3å¼€å‘æ¿
- æ”¯æŒWiFiè¿æ¥

#### è½¯ä»¶ä¾èµ–
åœ¨Arduino IDEä¸­å®‰è£…ä»¥ä¸‹åº“ï¼š
- `WiFi` (ESP32è‡ªå¸¦)
- `ArduinoWebsockets` by Gil Maimon
- `ArduinoJson` by Benoit Blanchon

æˆ–è€…å¦‚æœä½¿ç”¨PlatformIOï¼Œåœ¨`platformio.ini`ä¸­æ·»åŠ ï¼š
```ini
lib_deps = 
    bblanchon/ArduinoJson@^7.4.1
    gilmaimon/ArduinoWebsockets@^0.5.4
```

#### ç¤ºä¾‹ä»£ç 
å‚è€ƒ `esp32_example.ino` æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«ï¼š
- WiFiè¿æ¥é…ç½®
- WebSocketå®¢æˆ·ç«¯åˆå§‹åŒ–
- æ¶ˆæ¯å¤„ç†å‡½æ•°
- ä¼ æ„Ÿå™¨æ•°æ®å‘é€
- å¿ƒè·³æœºåˆ¶å®ç°

## é…ç½®è¯´æ˜

### WebSocketæœåŠ¡å™¨é…ç½®
é»˜è®¤é…ç½®ï¼š
- ä¸»æœº: `0.0.0.0` (ç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£)
- ç«¯å£: `8765`

å¦‚éœ€ä¿®æ”¹ï¼Œè¯·ç¼–è¾‘ `main.py` æ–‡ä»¶ä¸­çš„ç›¸å…³é…ç½®ï¼š

```python
self.server_host = "0.0.0.0"
self.server_port = 8765
```

### ESP32è¿æ¥é…ç½®
åœ¨ESP32ä»£ç ä¸­ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š

```cpp
// WiFié…ç½®
const char* ssid = "ä½ çš„WiFiåç§°";
const char* password = "ä½ çš„WiFiå¯†ç ";

// WebSocketæœåŠ¡å™¨é…ç½®
const char* websocket_server = "192.168.1.100";  // AstrBotæ‰€åœ¨ç”µè„‘çš„IPåœ°å€
const int websocket_port = 8765;
```

## æ¶ˆæ¯åè®®

### ESP32å‘é€ç»™AstrBotçš„æ¶ˆæ¯æ ¼å¼

#### çŠ¶æ€æ›´æ–°
```json
{
  "type": "status",
  "status": "connected",
  "device_id": "esp32s3_001",
  "timestamp": 12345
}
```

#### ä¼ æ„Ÿå™¨æ•°æ®
```json
{
  "type": "sensor_data",
  "device_id": "esp32s3_001",
  "data": {
    "temperature": 25.6,
    "humidity": 45.2,
    "light": 512
  },
  "timestamp": 12345
}
```

#### å¿ƒè·³æ¶ˆæ¯
```json
{
  "type": "heartbeat",
  "device_id": "esp32s3_001",
  "timestamp": 12345
}
```

### AstrBotå‘é€ç»™ESP32çš„æ¶ˆæ¯æ ¼å¼

#### å¹³å°æ¶ˆæ¯è½¬å‘
```json
{
  "type": "astrbot_message",
  "platform": "qq",
  "sender_id": "123456789",
  "sender_name": "ç”¨æˆ·å",
  "message_text": "å¼€ç¯",
  "message_type": "GroupMessage",
  "group_id": "987654321",
  "timestamp": 12345,
  "is_private": false,
  "is_admin": false,
  "components": [
    {
      "type": "text",
      "content": "å¼€ç¯"
    }
  ]
}
```

#### è‡ªå®šä¹‰å‘½ä»¤
```json
{
  "type": "custom_command",
  "command": "led_on",
  "from_user": "ç®¡ç†å‘˜",
  "timestamp": 12345
}
```

## åº”ç”¨åœºæ™¯

1. **æ™ºèƒ½å®¶å±…æ§åˆ¶**: é€šè¿‡èŠå¤©è½¯ä»¶æ§åˆ¶ESP32è¿æ¥çš„æ™ºèƒ½è®¾å¤‡
2. **ä¼ æ„Ÿå™¨ç›‘æ§**: å®æ—¶è·å–ESP32ä¼ æ„Ÿå™¨æ•°æ®å¹¶æ¨é€åˆ°èŠå¤©ç¾¤
3. **è¿œç¨‹è®¾å¤‡ç®¡ç†**: é€šè¿‡èŠå¤©æŒ‡ä»¤è¿œç¨‹é‡å¯ã€é…ç½®ESP32è®¾å¤‡
4. **ç‰©è”ç½‘æ•°æ®æ”¶é›†**: å°†ESP32è®¾å¤‡æ•°æ®æ±‡èšåˆ°AstrBotè¿›è¡Œå¤„ç†

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ESP32æ— æ³•è¿æ¥WebSocketæœåŠ¡å™¨**
   - æ£€æŸ¥WiFiè¿æ¥æ˜¯å¦æ­£å¸¸
   - ç¡®è®¤AstrBotæ‰€åœ¨ç”µè„‘çš„IPåœ°å€å’Œç«¯å£
   - æ£€æŸ¥é˜²ç«å¢™è®¾ç½®æ˜¯å¦é˜»æ­¢äº†8765ç«¯å£

2. **æ¶ˆæ¯æ— æ³•æ­£å¸¸è½¬å‘**
   - ç¡®è®¤æ’ä»¶å·²æ­£ç¡®åŠ è½½
   - æ£€æŸ¥WebSocketè¿æ¥çŠ¶æ€
   - æŸ¥çœ‹AstrBotæ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

3. **è®¾å¤‡é¢‘ç¹æ–­çº¿**
   - æ£€æŸ¥WiFiä¿¡å·å¼ºåº¦
   - è°ƒæ•´å¿ƒè·³é—´éš”æ—¶é—´
   - ç¡®è®¤ç½‘ç»œç¨³å®šæ€§

### è°ƒè¯•æ–¹æ³•

1. æŸ¥çœ‹AstrBotæ—¥å¿—ï¼šå…³æ³¨ESP32ç›¸å…³çš„æ—¥å¿—è¾“å‡º
2. ä½¿ç”¨ä¸²å£ç›‘è§†å™¨ï¼šæŸ¥çœ‹ESP32çš„è°ƒè¯•ä¿¡æ¯
3. ç½‘ç»œå·¥å…·ï¼šä½¿ç”¨websocketå®¢æˆ·ç«¯å·¥å…·æµ‹è¯•è¿æ¥

## å¼€å‘æ‰©å±•

### æ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹
åœ¨ `handle_esp32_message` æ–¹æ³•ä¸­æ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹å¤„ç†ï¼š

```python
elif message_type == "your_custom_type":
    # å¤„ç†è‡ªå®šä¹‰æ¶ˆæ¯ç±»å‹
    custom_data = data.get("custom_data", {})
    # ä½ çš„å¤„ç†é€»è¾‘
```

### å¢åŠ æ–°çš„æ§åˆ¶æŒ‡ä»¤
æ·»åŠ æ–°çš„commandè£…é¥°å™¨æ–¹æ³•ï¼š

```python
@filter.command("your_command")
async def your_command(self, event: AstrMessageEvent, param: str):
    # ä½ çš„æŒ‡ä»¤å¤„ç†é€»è¾‘
    pass
```

## è®¸å¯è¯

æœ¬æ’ä»¶åŸºäºMITè®¸å¯è¯å¼€æºï¼Œæ¬¢è¿è´¡çŒ®ä»£ç å’Œæå‡ºæ”¹è¿›å»ºè®®ã€‚

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-06-10)
- åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- å®ç°åŸºç¡€WebSocketæœåŠ¡å™¨åŠŸèƒ½
- æ”¯æŒæ¶ˆæ¯è½¬å‘å’Œè®¾å¤‡æ§åˆ¶
- æä¾›å®Œæ•´çš„ESP32ç¤ºä¾‹ä»£ç 
